# Sagemaker Training


## Reference 
- Container structure: https://docs.aws.amazon.com/sagemaker/latest/dg/amazon-sagemaker-toolkits.html
- Huggingface sagemaker tutor: https://huggingface.co/docs/sagemaker/train#installation-and-setup
- Sagemaker env variable list: https://github.com/aws/sagemaker-training-toolkit/blob/master/ENVIRONMENT_VARIABLES.md
- Sagemaker sdk: https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html



## How to use This template

- Modify Dockerfile if necessary
- Copy .env.example to create .env and modify the env variables
- Integrate your code in train.py




## Container structure
For the structure generated by SageMaker Training while running, reference to (here)[https://docs.aws.amazon.com/sagemaker/latest/dg/amazon-sagemaker-toolkits.html]

```
/opt/ml
├── input
│   ├── config
│   │   ├── hyperparameters.json
│   │   └── resourceConfig.json
│   └── data # the input data is put here
│       └── <channel_name>
│           └── <input data>
├── model # the training script should write the model to here.
│
├── code # the scripts that the container will run.
│
├── output
│
└── failure
```


## Build image

You can build the image as:
```
docker build -t <image tag> .
```



## Local Testing Sagemaker

Run SageMaker Training local mode script (local_estimator.py)
- Reminder: 
  - setup AWS-CLI credential first

```sh
python3 local_estimator.py
```



## I/O of sagemaker training

- input - `SM_CHANNEL_XXXX`: A string representing the path to the directory that contains the input data for the specified channel. For example, when you specify train and test in the Estimator fit method, the environment variables are set to SM_CHANNEL_TRAIN and SM_CHANNEL_TEST.

- output - `SM_MODEL_DIR`: A string representing the path to which the training job writes the model artifacts. After training, artifacts in this directory are uploaded to S3 for model hosting. SM_MODEL_DIR is always set to /opt/ml/model.

- other files should be stored to `/opt/ml/output/data` (Same as model sagemaker copies this as a tar file)
- [Optional] - if training failed, you can write failure reason in this file `/opt/ml/output/failure`, sagemaker returns the first 1024 character from this file


### Extended reading

- [Training storage important path](https://docs.aws.amazon.com/sagemaker/latest/dg/model-train-storage.html)
- [How sm training deal with output](https://docs.aws.amazon.com/sagemaker/latest/dg/your-algorithms-training-algo-output.html)
- [Container file structure](https://docs.aws.amazon.com/sagemaker/latest/dg/amazon-sagemaker-toolkits.html)
- SM ENV variable [list](https://github.com/aws/sagemaker-training-toolkit/blob/master/ENVIRONMENT_VARIABLES.md)