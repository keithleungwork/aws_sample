# Sagemaker Training


## Reference 
- Container structure: https://docs.aws.amazon.com/sagemaker/latest/dg/amazon-sagemaker-toolkits.html
- Huggingface sagemaker tutor: https://huggingface.co/docs/sagemaker/train#installation-and-setup
- Sagemaker env variable list: https://github.com/aws/sagemaker-training-toolkit/blob/master/ENVIRONMENT_VARIABLES.md
- Sagemaker sdk: https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html



## How to use This template

- Modify Dockerfile, and choose the appropriate AWS deep learning container
- Copy .env.example to create .env and modify the env variables
- Integrate your code in train.py




## Container structure
For the structure generated by SageMaker Training while running, reference to (here)[https://docs.aws.amazon.com/sagemaker/latest/dg/amazon-sagemaker-toolkits.html]

```
/opt/ml
├── input
│   ├── config
│   │   ├── hyperparameters.json
│   │   └── resourceConfig.json
│   └── data # the input data is put here
│       └── <channel_name>
│           └── <input data>
├── model # the training script should write the model to here.
│
├── code # the scripts that the container will run.
│
├── output
│
└── failure
```


## Build image

The dockerfile is built from aws Deep Learning Containers ECR, change the official ECR path to login. e.g. In tokyo region, the link is `763104351884.dkr.ecr.ap-northeast-1.amazonaws.com`.
```bash
aws ecr get-login-password --region <your region> |docker login --username AWS --password-stdin <your region ECR>.dkr.ecr.ap-northeast-1.amazonaws.com
```

After login, you can build the image as usual:
```
docker build -t <image tag> .
```



## Local Testing Sagemaker

Run SageMaker Training local mode script (local_estimator.py)
- Reminder: 
  - setup AWS-CLI credential first

```sh
python3 local_estimator.py
```



## I/O of sagemaker training

- input - `SM_CHANNEL_XXXX`: A string representing the path to the directory that contains the input data for the specified channel. For example, when you specify train and test in the Estimator fit method, the environment variables are set to SM_CHANNEL_TRAIN and SM_CHANNEL_TEST.

- output - `SM_MODEL_DIR`: A string representing the path to which the training job writes the model artifacts. After training, artifacts in this directory are uploaded to S3 for model hosting. SM_MODEL_DIR is always set to /opt/ml/model.
